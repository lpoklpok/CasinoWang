<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Friends Blackjack</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>♠️ Friends Blackjack ♥️</h1>

    <div class="balance">
      Balance: <span id="balance">500</span> chips
      | Current Bet: <span id="bet">0</span>
    </div>

    <div class="chips">
      <button class="chip" data-value="5">5</button>
      <button class="chip" data-value="25">25</button>
      <button class="chip" data-value="100">100</button>
      <button id="clearBet">Clear Bet</button>
    </div>

    <div class="controls">
      <button id="dealBtn">Deal</button>
      <button id="hitBtn" disabled>Hit</button>
      <button id="standBtn" disabled>Stand</button>
      <span id="status" class="status"></span>
    </div>

    <section class="table">
      <div class="hand">
        <h2>Dealer</h2>
        <div id="dealerCards" class="cards"></div>
        <div id="dealerTotal" class="total"></div>
      </div>
      <div class="hand">
        <h2>You</h2>
        <div id="playerCards" class="cards"></div>
        <div id="playerTotal" class="total"></div>
      </div>
    </section>

    <p class="note">For fun only. No real money.</p>
  </main>

  <script>
    let gameId = null;
    let balance = 500;
    let currentBet = 0;
    let roundActive = false;

    function renderCard(code, hidden=false) {
      if (hidden) return `<div class="card back"></div>`;
      const rank = code.slice(0, -1);
      const suitLetter = code.slice(-1);
      const suits = { S: "♠", H: "♥", D: "♦", C: "♣" };
      const suitSymbol = suits[suitLetter];
      const suitClass = (suitLetter === "H" || suitLetter === "D") ? "red" : "black";
      return `
        <div class="card ${suitClass}">
          <span class="rank">${rank}</span>
          <span class="suit">${suitSymbol}</span>
        </div>
      `;
    }

    function render(state) {
      document.getElementById("dealerCards").innerHTML =
        state.dealer.map((c, i) => renderCard(c, i === 1 && state.status === "player_turn")).join("");

      document.getElementById("playerCards").innerHTML =
        state.player.map(c => renderCard(c)).join("");

      document.getElementById("dealerTotal").textContent =
        state.dealerTotal !== null ? `Total: ${state.dealerTotal}` : "";
      document.getElementById("playerTotal").textContent =
        `Total: ${state.playerTotal}`;

      document.getElementById("status").textContent =
        state.status.replaceAll("_", " ");

      const playerTurn = state.status === "player_turn";
      document.getElementById("hitBtn").disabled = !playerTurn;
      document.getElementById("standBtn").disabled = !playerTurn;

      // End of round payout
      if (!playerTurn && roundActive) {
        roundActive = false;
        if (state.status === "player_win" || state.status === "player_blackjack") {
          balance += currentBet * 2; // win pays 1:1
        } else if (state.status === "push") {
          balance += currentBet; // return bet
        }
        currentBet = 0;
        updateUI();
      }
    }

    function updateUI() {
      document.getElementById("balance").textContent = balance;
      document.getElementById("bet").textContent = currentBet;
    }

    async function post(url, body = {}) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // Buttons
    document.querySelectorAll(".chip").forEach(btn => {
      btn.onclick = () => {
        if (roundActive) return;
        const value = parseInt(btn.dataset.value);
        if (balance >= value) {
          balance -= value;
          currentBet += value;
          updateUI();
        }
      };
    });

    document.getElementById("clearBet").onclick = () => {
      if (roundActive) return;
      balance += currentBet;
      currentBet = 0;
      updateUI();
    };

    document.getElementById("dealBtn").onclick = async () => {
      if (currentBet === 0) {
        alert("Place a bet first!");
        return;
      }
      try {
        const data = await post("/api/new-game");
        gameId = data.gameId;
        roundActive = true;
        render(data);
      } catch (e) { alert(e); }
    };

    document.getElementById("hitBtn").onclick = async () => {
      try {
        const data = await post("/api/hit", { gameId });
        render(data);
      } catch (e) { alert(e); }
    };

    document.getElementById("standBtn").onclick = async () => {
      try {
        const data = await post("/api/stand", { gameId });
        render(data);
      } catch (e) { alert(e); }
    };

    updateUI();
  </script>
</body>
</html>